<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Train of Thought - Simulator</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 3rem;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
            text-decoration: none;
        }
        .nav-links {
            display: flex;
            gap: 2rem;
        }
        .nav-links a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: color 0.3s;
        }
        .nav-links a:hover {
            color: #667eea;
        }
        .nav-links a.active {
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.25rem;
        }
        .page {
            padding: 3rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        .simulator-container {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        .simulator-container h2 {
            color: #667eea;
            margin-bottom: 2rem;
            font-size: 2.5rem;
            text-align: center;
        }
        .info-text {
            color: #666;
            font-size: 1.2rem;
            margin-bottom: 2rem;
            text-align: center;
        }
        #react-root {
            min-height: 50vh;
        }
        @media (max-width: 768px) {
            nav {
                flex-direction: column;
                gap: 1rem;
            }
            .page {
                padding: 1.5rem;
            }
            .simulator-container {
                padding: 2rem;
            }
            .simulator-container h2 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <nav>
        <a href="index.html" class="logo">Train of Thought</a>
        <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="simulator.html" class="active">Simulator</a>
            <a href="dashboard.html">Dashboard</a>
        </div>
    </nav>
    <div class="page">
        <div class="simulator-container">
            <h2>üß† AI-Powered Adaptive Simulator</h2>
            <p class="info-text">
                Intelligent scenarios generated from real data - 100% free, runs locally!
            </p>

            <div id="react-root"></div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const AdaptiveTrolleySimulator = () => {
          const [data, setData] = useState([]);
          const [currentScenario, setCurrentScenario] = useState(null);
          const [userChoices, setUserChoices] = useState([]);
          const [stage, setStage] = useState('loading');
          const [scenarioCount, setScenarioCount] = useState(0);
          const [aiInsight, setAiInsight] = useState('');
          const [error, setError] = useState(null);

          useEffect(() => {
            loadDataset();
          }, []);

          const loadDataset = async () => {
            try {
              const response = await fetch('./trolley.csv');
              
              if (!response.ok) {
                throw new Error('Could not load trolley.csv');
              }
              
              const csvText = await response.text();
              
              Papa.parse(csvText, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: (results) => {
                  if (results.data && results.data.length > 0) {
                    console.log('‚úÖ Dataset loaded:', results.data.length, 'rows');
                    setData(results.data);
                    setStage('playing');
                    generateIntelligentScenario(results.data, []);
                  } else {
                    throw new Error('Dataset is empty');
                  }
                },
                error: (error) => {
                  console.error('Parse error:', error);
                  setError('Error parsing CSV: ' + error.message);
                  setStage('error');
                }
              });
            } catch (err) {
              console.error('Error loading dataset:', err);
              setError('Error loading trolley.csv: ' + err.message);
              setStage('error');
            }
          };

          // AI Pattern Analysis Engine
          const analyzeUserPatterns = (choices) => {
            if (choices.length === 0) return null;

            const patterns = {
              age: { younger: 0, older: 0, neutral: 0 },
              gender: { male: 0, female: 0, neutral: 0 },
              fitness: { athletic: 0, overweight: 0, neutral: 0 },
              status: { high: 0, low: 0, neutral: 0 },
              quantity: { more: 0, fewer: 0, equal: 0 }
            };

            choices.forEach(choice => {
              const saved = choice.saved;
              const sacrificed = choice.sacrificed;

              // Age analysis
              const ageComparison = compareAge(saved.age, sacrificed.age);
              if (ageComparison === 'younger') patterns.age.younger++;
              else if (ageComparison === 'older') patterns.age.older++;
              else patterns.age.neutral++;

              // Gender analysis
              if (saved.gender !== sacrificed.gender) {
                if (saved.gender === 'male') patterns.gender.male++;
                else patterns.gender.female++;
              } else {
                patterns.gender.neutral++;
              }

              // Fitness analysis
              if (saved.fitness !== sacrificed.fitness) {
                if (saved.fitness === 'athletic') patterns.fitness.athletic++;
                else patterns.fitness.overweight++;
              } else {
                patterns.fitness.neutral++;
              }

              // Status analysis
              if (saved.status !== sacrificed.status) {
                const savedStatusLevel = getStatusLevel(saved.status);
                const sacrificedStatusLevel = getStatusLevel(sacrificed.status);
                if (savedStatusLevel > sacrificedStatusLevel) patterns.status.high++;
                else if (savedStatusLevel < sacrificedStatusLevel) patterns.status.low++;
                else patterns.status.neutral++;
              } else {
                patterns.status.neutral++;
              }

              // Quantity analysis
              if (saved.count > sacrificed.count) patterns.quantity.more++;
              else if (saved.count < sacrificed.count) patterns.quantity.fewer++;
              else patterns.quantity.equal++;
            });

            return patterns;
          };

          const compareAge = (age1, age2) => {
            const ageOrder = ['child', 'young adult', 'adult', 'middle-aged', 'elderly'];
            const idx1 = ageOrder.findIndex(a => age1.toLowerCase().includes(a));
            const idx2 = ageOrder.findIndex(a => age2.toLowerCase().includes(a));
            if (idx1 < idx2) return 'younger';
            if (idx1 > idx2) return 'older';
            return 'equal';
          };

          const getStatusLevel = (status) => {
            const statusLevels = {
              'doctor': 5, 'executive': 5, 'ceo': 5,
              'teacher': 4, 'engineer': 4, 'nurse': 4,
              'worker': 3, 'employee': 3,
              'unemployed': 2,
              'homeless': 1
            };
            for (let key in statusLevels) {
              if (status.toLowerCase().includes(key)) return statusLevels[key];
            }
            return 3;
          };

          // Intelligent Scenario Generator
          const generateIntelligentScenario = (dataset, choices) => {
            const patterns = analyzeUserPatterns(choices);
            
            // Determine what dimension to focus on based on user's patterns
            let focusDimension = 'age'; // default
            let insight = '';

            if (choices.length === 0) {
              // First scenario: simple age difference
              insight = 'Starting with a basic moral dilemma to understand your baseline preferences.';
            } else if (choices.length === 1) {
              // Second scenario: introduce gender
              focusDimension = 'gender';
              insight = 'Adding gender as a new factor to see how it influences your decisions.';
            } else if (choices.length === 2) {
              // Third scenario: introduce fitness
              focusDimension = 'fitness';
              insight = 'Testing how physical characteristics affect your moral judgments.';
            } else {
              // Analyze strongest bias and challenge it
              const biasStrengths = [];
              
              if (patterns.age.younger > patterns.age.older) {
                biasStrengths.push({ 
                  type: 'age', 
                  strength: patterns.age.younger / choices.length,
                  preference: 'younger'
                });
              }
              if (patterns.gender.male > patterns.gender.female) {
                biasStrengths.push({ 
                  type: 'gender', 
                  strength: patterns.gender.male / choices.length,
                  preference: 'male'
                });
              }
              if (patterns.fitness.athletic > patterns.fitness.overweight) {
                biasStrengths.push({ 
                  type: 'fitness', 
                  strength: patterns.fitness.athletic / choices.length,
                  preference: 'athletic'
                });
              }
              if (patterns.status.high > patterns.status.low) {
                biasStrengths.push({ 
                  type: 'status', 
                  strength: patterns.status.high / choices.length,
                  preference: 'high status'
                });
              }

              biasStrengths.sort((a, b) => b.strength - a.strength);

              if (biasStrengths.length > 0 && biasStrengths[0].strength > 0.6) {
                focusDimension = biasStrengths[0].type;
                insight = `You've shown a ${Math.round(biasStrengths[0].strength * 100)}% preference for ${biasStrengths[0].preference} people. This scenario challenges that bias.`;
              } else {
                focusDimension = ['age', 'gender', 'fitness', 'status'][Math.floor(Math.random() * 4)];
                insight = 'Your choices are balanced. Testing a complex multi-factor scenario.';
              }
            }

            const scenario = createScenarioByDimension(focusDimension, patterns, choices.length);
            
            setCurrentScenario(scenario);
            setAiInsight(insight);
            setScenarioCount(choices.length + 1);
          };

          const createScenarioByDimension = (dimension, patterns, choiceCount) => {
            const ages = ['child', 'young adult', 'adult', 'elderly'];
            const genders = ['male', 'female'];
            const fitnesses = ['athletic', 'average', 'overweight'];
            const statuses = ['doctor', 'teacher', 'worker', 'unemployed', 'homeless'];

            let groupA, groupB;

            if (dimension === 'age') {
              // Challenge age preference
              const youngerAge = ages[Math.floor(Math.random() * 2)];
              const olderAge = ages[2 + Math.floor(Math.random() * 2)];
              
              groupA = {
                count: Math.floor(Math.random() * 2) + 1,
                age: youngerAge,
                gender: genders[Math.floor(Math.random() * 2)],
                fitness: fitnesses[Math.floor(Math.random() * 3)],
                status: statuses[Math.floor(Math.random() * 5)],
                description: `${Math.floor(Math.random() * 2) + 1} ${youngerAge} ${genders[Math.floor(Math.random() * 2)]} ${statuses[Math.floor(Math.random() * 5)]}`
              };
              
              groupB = {
                count: Math.floor(Math.random() * 2) + 2,
                age: olderAge,
                gender: genders[Math.floor(Math.random() * 2)],
                fitness: fitnesses[Math.floor(Math.random() * 3)],
                status: statuses[Math.floor(Math.random() * 5)],
                description: `${Math.floor(Math.random() * 2) + 2} ${olderAge} ${genders[Math.floor(Math.random() * 2)]} ${statuses[Math.floor(Math.random() * 5)]}`
              };
            } else if (dimension === 'gender') {
              const age = ages[Math.floor(Math.random() * 4)];
              
              groupA = {
                count: Math.floor(Math.random() * 2) + 1,
                age: age,
                gender: 'male',
                fitness: fitnesses[Math.floor(Math.random() * 3)],
                status: statuses[Math.floor(Math.random() * 5)],
                description: `${Math.floor(Math.random() * 2) + 1} ${age} male ${statuses[Math.floor(Math.random() * 5)]}`
              };
              
              groupB = {
                count: Math.floor(Math.random() * 2) + 1,
                age: age,
                gender: 'female',
                fitness: fitnesses[Math.floor(Math.random() * 3)],
                status: statuses[Math.floor(Math.random() * 5)],
                description: `${Math.floor(Math.random() * 2) + 1} ${age} female ${statuses[Math.floor(Math.random() * 5)]}`
              };
            } else if (dimension === 'fitness') {
              const age = ages[Math.floor(Math.random() * 4)];
              const gender = genders[Math.floor(Math.random() * 2)];
              
              groupA = {
                count: 1,
                age: age,
                gender: gender,
                fitness: 'athletic',
                status: statuses[Math.floor(Math.random() * 5)],
                description: `1 athletic ${age} ${gender} ${statuses[Math.floor(Math.random() * 5)]}`
              };
              
              groupB = {
                count: 1,
                age: age,
                gender: gender,
                fitness: 'overweight',
                status: statuses[Math.floor(Math.random() * 5)],
                description: `1 overweight ${age} ${gender} ${statuses[Math.floor(Math.random() * 5)]}`
              };
            } else { // status
              const age = ages[Math.floor(Math.random() * 4)];
              const gender = genders[Math.floor(Math.random() * 2)];
              
              groupA = {
                count: 1,
                age: age,
                gender: gender,
                fitness: fitnesses[Math.floor(Math.random() * 3)],
                status: 'doctor',
                description: `1 ${age} ${gender} doctor`
              };
              
              groupB = {
                count: 2,
                age: age,
                gender: gender,
                fitness: fitnesses[Math.floor(Math.random() * 3)],
                status: 'homeless',
                description: `2 ${age} ${gender} homeless people`
              };
            }

            const contexts = [
              "A runaway trolley is heading down the tracks.",
              "An out-of-control train is approaching a junction.",
              "A vehicle has lost its brakes on a slope.",
              "A dangerous situation requires immediate action."
            ];

            return {
              context: contexts[Math.floor(Math.random() * contexts.length)],
              groupA: groupA,
              groupB: groupB
            };
          };

          const handleChoice = (choice) => {
            const saved = choice === 'A' ? currentScenario.groupA : currentScenario.groupB;
            const sacrificed = choice === 'A' ? currentScenario.groupB : currentScenario.groupA;

            const newChoice = {
              scenarioNum: scenarioCount,
              choice: choice,
              saved: saved,
              sacrificed: sacrificed,
              scenario: {
                groupA: currentScenario.groupA,
                groupB: currentScenario.groupB,
                context: currentScenario.context
              },
              timestamp: new Date().toISOString()
            };

            const newChoices = [...userChoices, newChoice];
            setUserChoices(newChoices);

            if (newChoices.length >= 10) {
              localStorage.setItem('trolleyChoices', JSON.stringify(newChoices));
              window.location.href = './dashboard.html';
            } else {
              generateIntelligentScenario(data, newChoices);
            }
          };

          if (stage === 'loading') {
            return (
              <div style={{ textAlign: 'center', padding: '4rem 0' }}>
                <div style={{ width: '60px', height: '60px', border: '4px solid #f3f4f6', borderTop: '4px solid #667eea', borderRadius: '50%', margin: '0 auto 2rem', animation: 'spin 1s linear infinite' }} />
                <h3 style={{ color: '#667eea', marginBottom: '0.5rem' }}>Loading AI Engine</h3>
                <p style={{ color: '#666' }}>Loading dataset and initializing pattern recognition...</p>
                <style>{`@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`}</style>
              </div>
            );
          }

          if (stage === 'error') {
            return (
              <div style={{ textAlign: 'center', padding: '4rem 2rem' }}>
                <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>‚ö†Ô∏è</div>
                <h3 style={{ color: '#dc2626', marginBottom: '1rem' }}>Error Loading Dataset</h3>
                <p style={{ color: '#666', marginBottom: '2rem' }}>{error}</p>
                <button onClick={loadDataset} style={{ background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', color: 'white', padding: '0.75rem 2rem', borderRadius: '50px', border: 'none', fontWeight: 'bold', cursor: 'pointer' }}>Retry</button>
              </div>
            );
          }

          if (stage === 'playing') {
            const progress = (userChoices.length / 10) * 100;

            return (
              <div>
                <div style={{ marginBottom: '2rem' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', color: '#666', marginBottom: '0.5rem', fontSize: '0.9rem' }}>
                    <span>Scenario {scenarioCount} of 10</span>
                    <span>{Math.round(progress)}% Complete</span>
                  </div>
                  <div style={{ width: '100%', background: '#e5e7eb', borderRadius: '50px', height: '8px', overflow: 'hidden' }}>
                    <div style={{ width: `${progress}%`, background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', height: '100%', transition: 'width 0.3s ease', borderRadius: '50px' }} />
                  </div>
                </div>

                {aiInsight && (
                  <div style={{ background: 'linear-gradient(135deg, #667eea15 0%, #764ba215 100%)', padding: '1.5rem', borderRadius: '15px', marginBottom: '2rem', border: '1px solid rgba(102, 126, 234, 0.2)' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.5rem' }}>
                      <span style={{ fontSize: '1.2rem' }}>üß†</span>
                      <strong style={{ color: '#667eea' }}>AI Pattern Analysis</strong>
                    </div>
                    <p style={{ color: '#555', margin: 0 }}>{aiInsight}</p>
                  </div>
                )}

                {currentScenario && (
                  <>
                    <div style={{ background: 'linear-gradient(to right, #fee2e2, #fef3c7)', borderLeft: '4px solid #dc2626', borderRadius: '0 10px 10px 0', padding: '1.5rem', marginBottom: '2rem' }}>
                      <h3 style={{ fontSize: '1.3rem', color: '#333', marginBottom: '0.75rem', fontWeight: '600' }}>
                        {currentScenario.context} You must choose who lives.
                      </h3>
                      <p style={{ color: '#666', margin: 0, fontSize: '1.05rem' }}>Who do you save?</p>
                    </div>

                    <div style={{ display: 'grid', gridTemplateColumns: window.innerWidth > 768 ? '1fr 1fr' : '1fr', gap: '1.5rem', marginBottom: '2rem' }}>
                      <button onClick={() => handleChoice('A')} style={{ background: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)', border: 'none', borderRadius: '15px', padding: '2rem', cursor: 'pointer', transition: 'all 0.3s', color: 'white', textAlign: 'left', boxShadow: '0 4px 15px rgba(59, 130, 246, 0.3)' }} onMouseEnter={(e) => { e.currentTarget.style.transform = 'translateY(-5px)'; e.currentTarget.style.boxShadow = '0 8px 25px rgba(59, 130, 246, 0.4)'; }} onMouseLeave={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = '0 4px 15px rgba(59, 130, 246, 0.3)'; }}>
                        <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>{currentScenario.groupA.count > 1 ? 'üë•' : 'üßç'}</div>
                        <div style={{ fontSize: '1.5rem', fontWeight: 'bold', marginBottom: '1rem' }}>Save Option A</div>
                        <div style={{ fontSize: '1.1rem', marginBottom: '0.75rem', fontWeight: '500' }}>{currentScenario.groupA.description}</div>
                        <div style={{ fontSize: '0.9rem', opacity: 0.9 }}>{currentScenario.groupA.count} {currentScenario.groupA.count > 1 ? 'people' : 'person'}</div>
                      </button>

                      <button onClick={() => handleChoice('B')} style={{ background: 'linear-gradient(135deg, #a855f7 0%, #9333ea 100%)', border: 'none', borderRadius: '15px', padding: '2rem', cursor: 'pointer', transition: 'all 0.3s', color: 'white', textAlign: 'left', boxShadow: '0 4px 15px rgba(168, 85, 247, 0.3)' }} onMouseEnter={(e) => { e.currentTarget.style.transform = 'translateY(-5px)'; e.currentTarget.style.boxShadow = '0 8px 25px rgba(168, 85, 247, 0.4)'; }} onMouseLeave={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = '0 4px 15px rgba(168, 85, 247, 0.3)'; }}>
                        <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>{currentScenario.groupB.count > 1 ? 'üë•' : 'üßç'}</div>
                        <div style={{ fontSize: '1.5rem', fontWeight: 'bold', marginBottom: '1rem' }}>Save Option B</div>
                        <div style={{ fontSize: '1.1rem', marginBottom: '0.75rem', fontWeight: '500' }}>{currentScenario.groupB.description}</div>
                        <div style={{ fontSize: '0.9rem', opacity: 0.9 }}>{currentScenario.groupB.count} {currentScenario.groupB.count > 1 ? 'people' : 'person'}</div>
                      </button>
                    </div>
                  </>
                )}
              </div>
            );
          }

          return null;
        };

        ReactDOM.render(<AdaptiveTrolleySimulator />, document.getElementById('react-root'));
    </script>
</body>
</html>
