<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Train of Thought - Dashboard</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 3rem;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
            text-decoration: none;
        }
        .nav-links {
            display: flex;
            gap: 2rem;
        }
        .nav-links a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: color 0.3s;
        }
        .nav-links a:hover {
            color: #667eea;
        }
        .nav-links a.active {
            color: #667eea;
            border-bottom: 2px solid #667eea;
        }
        .page {
            padding: 3rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        .dashboard-container {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        .dashboard-container h2 {
            color: #667eea;
            margin-bottom: 2rem;
            font-size: 2.5rem;
        }
        @media (max-width: 768px) {
            nav {
                flex-direction: column;
                gap: 1rem;
            }
            .page {
                padding: 1.5rem;
            }
            .dashboard-container {
                padding: 2rem;
            }
        }
    </style>
</head>
<body>
    <nav>
        <a href="index.html" class="logo">Train of Thought</a>
        <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="simulator.html">Simulator</a>
            <a href="dashboard.html" class="active">Dashboard</a>
        </div>
    </nav>
    <div class="page">
        <div class="dashboard-container">
            <div id="root"></div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const Dashboard = () => {
          const [choices, setChoices] = useState([]);
          const [analysis, setAnalysis] = useState(null);
          const [loading, setLoading] = useState(true);

          useEffect(() => {
            loadChoicesAndAnalyze();
          }, []);

          const loadChoicesAndAnalyze = async () => {
            const storedChoices = localStorage.getItem('trolleyChoices');
            
            if (!storedChoices) {
              setLoading(false);
              return;
            }

            const parsedChoices = JSON.parse(storedChoices);
            setChoices(parsedChoices);

            await performAIAnalysis(parsedChoices);
          };

          const performAIAnalysis = async (choices) => {
            try {
              const prompt = `Analyze this user's moral decision-making patterns from 10 trolley scenarios.

CHOICES: ${JSON.stringify(choices.map(c => ({ scenario: c.scenarioNum, saved: c.saved, sacrificed: c.sacrificed })), null, 2)}

Calculate percentages for: age, gender, fitness, status, utilitarian preferences.

Respond ONLY with valid JSON:
{
  "agePreference": {"younger": number, "older": number, "neutral": number},
  "genderPreference": {"male": number, "female": number, "neutral": number},
  "fitnessPreference": {"athletic": number, "overweight": number, "neutral": number},
  "statusPreference": {"high": number, "low": number, "neutral": number},
  "utilitarian": {"saveMore": number, "saveFewer": number, "neutral": number},
  "ethicalFramework": "string",
  "keyInsights": ["string", "string", "string"],
  "comparisonToPopulation": "string"
}`;

              const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  model: 'claude-sonnet-4-20250514',
                  max_tokens: 1500,
                  messages: [{ role: 'user', content: prompt }]
                })
              });

              const result = await response.json();
              const aiResponse = result.content.find(c => c.type === 'text')?.text || '';
              const cleanJson = aiResponse.replace(/```json|```/g, '').trim();
              const analysisResult = JSON.parse(cleanJson);
              
              setAnalysis(analysisResult);
            } catch (error) {
              console.error('Error:', error);
            } finally {
              setLoading(false);
            }
          };

          const getTotal = (pref) => (pref.younger ?? 0) + (pref.older ?? 0) + (pref.neutral ?? 0) || 
                                     (pref.male ?? 0) + (pref.female ?? 0) + (pref.neutral ?? 0) ||
                                     (pref.athletic ?? 0) + (pref.overweight ?? 0) + (pref.neutral ?? 0) ||
                                     (pref.high ?? 0) + (pref.low ?? 0) + (pref.neutral ?? 0) ||
                                     (pref.saveMore ?? 0) + (pref.saveFewer ?? 0) + (pref.neutral ?? 0);

          const getPercentage = (val, pref) => {
            const total = getTotal(pref);
            return total > 0 ? ((val / total) * 100).toFixed(0) : 0;
          };

          const resetData = () => {
            localStorage.removeItem('trolleyChoices');
            window.location.href = './simulator.html';
          };

          if (loading) {
            return (
              <div style={{ textAlign: 'center', padding: '4rem 0' }}>
                <div style={{ width: '60px', height: '60px', border: '4px solid #f3f4f6', borderTop: '4px solid #667eea', borderRadius: '50%', margin: '0 auto 2rem', animation: 'spin 1s linear infinite' }} />
                <h2 style={{ color: '#667eea', marginBottom: '0.5rem' }}>Analyzing Your Choices</h2>
                <p style={{ color: '#666' }}>AI is performing deep moral pattern analysis...</p>
                <style>{`@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`}</style>
              </div>
            );
          }

          if (!choices || choices.length === 0) {
            return (
              <div style={{ textAlign: 'center', padding: '4rem 2rem' }}>
                <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>ðŸ“Š</div>
                <h2 style={{ color: '#667eea', marginBottom: '1rem' }}>No Data Available</h2>
                <p style={{ color: '#666', marginBottom: '2rem' }}>Complete the simulator first to see your moral profile analysis.</p>
                <a href="./simulator.html" style={{ display: 'inline-block', background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', color: 'white', padding: '0.75rem 2rem', borderRadius: '50px', textDecoration: 'none', fontWeight: 'bold' }}>Start Simulator</a>
              </div>
            );
          }

          return (
            <div>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem' }}>
                <h2 style={{ color: '#667eea', margin: 0 }}>ðŸ§  Your Moral Profile</h2>
                <button onClick={resetData} style={{ background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', color: 'white', padding: '0.75rem 1.5rem', borderRadius: '50px', border: 'none', fontWeight: 'bold', cursor: 'pointer' }}>Take New Test</button>
              </div>

              {analysis ? (
                <>
                  <div style={{ background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', color: 'white', borderRadius: '15px', padding: '2rem', marginBottom: '2rem' }}>
                    <h3 style={{ fontSize: '1.3rem', fontWeight: 'bold', marginBottom: '0.75rem' }}>Ethical Framework Detected</h3>
                    <p style={{ fontSize: '1.1rem', margin: 0 }}>{analysis.ethicalFramework}</p>
                  </div>

                  <div style={{ display: 'grid', gridTemplateColumns: window.innerWidth > 768 ? '1fr 1fr' : '1fr', gap: '1.5rem', marginBottom: '2rem' }}>
                    {[
                      { title: 'Age Preference', label: 'Saved Younger People', pref: analysis.agePreference, key: 'younger', color: '#3b82f6' },
                      { title: 'Gender Preference', label: 'Saved Male', pref: analysis.genderPreference, key: 'male', color: '#a855f7' },
                      { title: 'Fitness Preference', label: 'Saved Athletic', pref: analysis.fitnessPreference, key: 'athletic', color: '#22c55e' },
                      { title: 'Status Preference', label: 'Saved Higher Status', pref: analysis.statusPreference, key: 'high', color: '#f59e0b' },
                      { title: 'Utilitarian', label: 'Saved More People', pref: analysis.utilitarian, key: 'saveMore', color: '#ef4444' }
                    ].map((item, idx) => (
                      <div key={idx} style={{ background: 'linear-gradient(135deg, #667eea15 0%, #764ba215 100%)', borderRadius: '15px', padding: '1.5rem' }}>
                        <h3 style={{ color: '#667eea', marginBottom: '1rem', fontSize: '1.1rem', fontWeight: '600' }}>{item.title}</h3>
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
                          <span style={{ fontSize: '0.9rem', color: '#555' }}>{item.label}</span>
                          <span style={{ fontWeight: 'bold', color: item.color }}>{getPercentage(item.pref[item.key], item.pref)}%</span>
                        </div>
                        <div style={{ width: '100%', background: '#e5e7eb', borderRadius: '50px', height: '10px', overflow: 'hidden' }}>
                          <div style={{ width: `${getPercentage(item.pref[item.key], item.pref)}%`, background: item.color, height: '100%', borderRadius: '50px', transition: 'width 0.5s ease' }} />
                        </div>
                      </div>
                    ))}
                  </div>

                  <div style={{ background: 'linear-gradient(135deg, #667eea15 0%, #764ba215 100%)', borderRadius: '15px', padding: '2rem', marginBottom: '2rem', border: '2px solid rgba(102, 126, 234, 0.3)' }}>
                    <h3 style={{ color: '#667eea', marginBottom: '1rem', fontSize: '1.2rem', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                      <span>ðŸ§ </span>
                      AI Key Insights
                    </h3>
                    <ul style={{ listStyle: 'none', padding: 0, margin: 0 }}>
                      {analysis.keyInsights.map((insight, idx) => (
                        <li key={idx} style={{ background: 'white', padding: '1rem', borderRadius: '10px', marginBottom: '0.75rem', color: '#555', display: 'flex', alignItems: 'start', gap: '0.75rem' }}>
                          <span style={{ color: '#667eea', fontWeight: 'bold', fontSize: '1.2rem' }}>â€¢</span>
                          <span style={{ flex: 1 }}>{insight}</span>
                        </li>
                      ))}
                    </ul>
                  </div>

                  <div style={{ background: 'linear-gradient(135deg, #a855f715 0%, #ec489915 100%)', borderRadius: '15px', padding: '2rem', marginBottom: '2rem', border: '2px solid rgba(168, 85, 247, 0.3)' }}>
                    <h3 style={{ color: '#a855f7', marginBottom: '1rem', fontSize: '1.2rem', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                      <span>ðŸ‘¥</span>
                      Comparison to Population
                    </h3>
                    <p style={{ color: '#555', lineHeight: '1.6', margin: 0 }}>{analysis.comparisonToPopulation}</p>
                  </div>
                </>
              ) : (
                <div style={{ textAlign: 'center', padding: '3rem 0' }}>
                  <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>ðŸ¤”</div>
                  <p style={{ color: '#666' }}>Unable to generate analysis. Please try again.</p>
                </div>
              )}

              <div style={{ background: 'white', border: '2px solid #e5e7eb', borderRadius: '15px', padding: '2rem' }}>
                <h3 style={{ color: '#667eea', marginBottom: '1.5rem', fontSize: '1.3rem', fontWeight: '600' }}>Your Decision History</h3>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                  {choices.map((choice, idx) => (
                    <div key={idx} style={{ background: '#f9fafb', borderRadius: '10px', padding: '1.5rem', borderLeft: '4px solid #667eea' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.75rem', alignItems: 'center' }}>
                        <span style={{ fontWeight: '600', color: '#667eea' }}>Scenario {choice.scenarioNum}</span>
                        <span style={{ fontSize: '0.85rem', color: '#999' }}>{new Date(choice.timestamp).toLocaleString()}</span>
                      </div>
                      <div style={{ display: 'grid', gridTemplateColumns: window.innerWidth > 768 ? '1fr 1fr' : '1fr', gap: '1rem', fontSize: '0.95rem' }}>
                        <div style={{ background: '#d1fae5', padding: '1rem', borderRadius: '8px', border: '1px solid #6ee7b7' }}>
                          <div style={{ fontWeight: '600', color: '#059669', marginBottom: '0.5rem' }}>âœ“ Saved</div>
                          <div style={{ color: '#555' }}>{choice.saved.description}</div>
                        </div>
                        <div style={{ background: '#fee2e2', padding: '1rem', borderRadius: '8px', border: '1px solid #fca5a5' }}>
                          <div style={{ fontWeight: '600', color: '#dc2626', marginBottom: '0.5rem' }}>âœ— Sacrificed</div>
                          <div style={{ color: '#555' }}>{choice.sacrificed.description}</div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          );
        };

        ReactDOM.render(<Dashboard />, document.getElementById('root'));
    </script>
</body>
</html>
